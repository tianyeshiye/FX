package ty.fx.macd.ea;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.math.BigDecimal;
import java.math.MathContext;
import java.math.RoundingMode;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;

import ty.fx.macd.MacdDataBean;
import ty.fx.macd.MacdResultBean;
import ty.fx.macd.Macds;
import ty.fx.utils.ExcelFileUtils;

public class MacdStop {

	private static final SimpleDateFormat dataFormat_yyyyMMddHHmmss = new SimpleDateFormat("yyyyMMddHHmmss");

	public List<String> ea(List<MacdDataBean> beanList, List<MacdResultBean> resulList) {

		List<String> outputList = new ArrayList<String>();

		int win = 0;
		int lose = 0;
		float fuKui = 0;

		float start = 0;
		float end = 0;

		MacdDataBean holderMacdDataBean = null;
		int holderType = -1; // 1:买 0 卖

		for (int i = 0; i < beanList.size(); i++) {

			MacdDataBean before1Bean;
			MacdDataBean before2Bean;

			if (i == 0) {
				before1Bean = Macds.getNullBean();
				before2Bean = Macds.getNullBean();
			} else if (i == 1) {

				before1Bean = beanList.get(0);
				before2Bean = Macds.getNullBean();
			} else {
				before1Bean = beanList.get(i - 1);
				before2Bean = beanList.get(i - 2);
			}

			MacdDataBean currentBean = beanList.get(i);

			// 判断是否达到止损

			if (holderMacdDataBean != null) {

				BigDecimal stopBigDecimal = new BigDecimal(3).setScale(5, BigDecimal.ROUND_DOWN);

				BigDecimal startBigDecimal = new BigDecimal(end).setScale(5, BigDecimal.ROUND_DOWN);
				BigDecimal highBigDecimal = new BigDecimal(currentBean.getHigh()).setScale(5, BigDecimal.ROUND_DOWN);
				BigDecimal lowBigDecimal = new BigDecimal(currentBean.getLow()).setScale(5, BigDecimal.ROUND_DOWN);

				if (holderType == 1) {
					// 买
					int compare = startBigDecimal.subtract(stopBigDecimal).compareTo(lowBigDecimal);

					float jiesuan = lowBigDecimal.subtract(startBigDecimal).setScale(5, BigDecimal.ROUND_DOWN)
							.floatValue();

					if (compare > 0) {

						// 离场 止损
						holderMacdDataBean = null;
						holderType = -1;
						start = 0;

						lose++;
						outputList.add("出 - 卖," + currentBean.toString() + ",亏" + ",-1");

						MacdResultBean macdResultBean = new MacdResultBean("出 - 卖", "亏", jiesuan, currentBean);
						resulList.add(macdResultBean);
					}

				}

				if (holderType == 0) {
					// 卖
					int compare = startBigDecimal.add(stopBigDecimal).compareTo(highBigDecimal);

					float jiesuan = startBigDecimal.subtract(lowBigDecimal).setScale(5, BigDecimal.ROUND_DOWN)
							.floatValue();

					if (compare < 0) {

						// 离场 止损
						holderMacdDataBean = null;
						holderType = -1;
						start = 0;

						lose++;
						outputList.add("出 - 买," + currentBean.toString() + ",亏" + ",-1");

						MacdResultBean macdResultBean = new MacdResultBean("出 - 买", "亏", jiesuan, currentBean);
						resulList.add(macdResultBean);
						
						fuKui = fuKui + jiesuan;
						outputList.add("总浮亏," + fuKui + ",本次结算," + String.valueOf(jiesuan));
					}
				}
			}

			// fase 由 负 -> 正
			if ((currentBean.getDif() > 0 && before1Bean.getDif() == 0 && before2Bean.getDif() < 0)
					|| (currentBean.getDif() > 0 && before1Bean.getDif() < 0)) {

				if (start != 0) {
					// 已持有
					// 出场
					end = currentBean.getClose();

					BigDecimal jiesuanEnd = new BigDecimal(end).setScale(5, BigDecimal.ROUND_DOWN);
					BigDecimal jiesuanStart = new BigDecimal(start).setScale(5, BigDecimal.ROUND_DOWN);

					float jiesuan = jiesuanStart.subtract(jiesuanEnd).setScale(5, BigDecimal.ROUND_DOWN).floatValue();

					if (jiesuan >= 0) {
						// win
						win++;
						outputList.add("出 - 买," + currentBean.toString() + ",盈" + ",1");

						MacdResultBean macdResultBean = new MacdResultBean("出 - 买", "盈", jiesuan, currentBean);
						resulList.add(macdResultBean);

					} else {
						lose++;
						outputList.add("出 - 买," + currentBean.toString() + ",亏" + ",-1");

						MacdResultBean macdResultBean = new MacdResultBean("出 - 买", "亏", jiesuan, currentBean);
						resulList.add(macdResultBean);
					}

					fuKui = fuKui + jiesuan;
					outputList.add("总浮亏," + fuKui + ",本次结算," + String.valueOf(jiesuan));

					// 离场
					holderMacdDataBean = null;
					holderType = -1;
					start = 0;
				}
				// 进场 买入
				start = currentBean.getClose();

				holderMacdDataBean = currentBean;
				holderType = 1;

				outputList.add("进 - 买," + currentBean.toString());
			}
			// fase 由 正 -> 负
			if ((currentBean.getDif() < 0 && before1Bean.getDif() == 0 && before2Bean.getDif() > 0)
					|| (currentBean.getDif() < 0 && before1Bean.getDif() > 0)) {

				if (start != 0) {
					// 已持有
					// 出场
					end = currentBean.getClose();

					BigDecimal jiesuanEnd = new BigDecimal(end).setScale(5, BigDecimal.ROUND_DOWN);
					BigDecimal jiesuanStart = new BigDecimal(start).setScale(5, BigDecimal.ROUND_DOWN);

					float jiesuan = jiesuanEnd.subtract(jiesuanStart).setScale(5, BigDecimal.ROUND_DOWN).floatValue();

					if (jiesuan >= 0) {
						// win
						win++;
						outputList.add("出 - 卖," + currentBean.toString() + ",盈" + ",1");

						MacdResultBean macdResultBean = new MacdResultBean("出 - 卖", "盈", jiesuan, currentBean);
						resulList.add(macdResultBean);
					} else {
						lose++;
						outputList.add("出 - 卖," + currentBean.toString() + ",亏" + ",-1");

						MacdResultBean macdResultBean = new MacdResultBean("出 - 卖", "亏", jiesuan, currentBean);
						resulList.add(macdResultBean);
					}

					fuKui = fuKui + jiesuan;
					outputList.add("总浮亏," + fuKui + ",本次结算," + String.valueOf(jiesuan));

					// 离场
					holderMacdDataBean = null;
					holderType = -1;
					start = 0;
				}
				// 进场 卖出
				start = currentBean.getClose();

				holderMacdDataBean = currentBean;
				holderType = 0;

				outputList.add("进 - 卖," + currentBean.toString());
			}

		}

		outputList.add("win," + win);
		outputList.add("lose," + lose);

		BigDecimal winR = new BigDecimal(win).setScale(0, BigDecimal.ROUND_DOWN);
		BigDecimal totalR = new BigDecimal(win + lose).setScale(0, BigDecimal.ROUND_DOWN);
		float rate = winR.divide(totalR, 2, BigDecimal.ROUND_DOWN).floatValue();

		outputList.add("rate," + rate);
		outputList.add("fuKui," + fuKui);

		System.out.println("win:" + win);
		System.out.println("lose:" + lose);
		System.out.println("rate:" + rate);
		System.out.println("fuKui:" + fuKui);

		return outputList;
	}

}
